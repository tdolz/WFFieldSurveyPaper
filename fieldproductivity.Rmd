---
title: "TaraCDF_skyler"
author: "tara"
date: "5/20/2020"
output:
  pdf_document: default
  html_document: default
theme: readable
---

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, cache=TRUE)
```

## R Markdown

Converting this to markdown because it's easier to keep it together. 

**Analyses**  
+ Are there significant differences between occupied and available habitat *within each bay* in terms of temperature, salinity, dissolved oxygen.  
    - Weight catch by year. test stat is the permutation test. separate analyses for each bay.      
+ Are there differences *between bays* in time [date] and temperature when fish become fully selected to the gear [first peak in abundance].  
    - subset the data leading up to the peak abundance. find the temperature at the 50th percentile. plot all the bays on one graph. weight by bay. could do this separately for shinnecock peaks. 


**Total sampled area**
I did some rough area calculations in google earth based on previous sample maps. 
Sample maps can be found in the powerpoint "Sampling maps w stations for first SK grant 2016"
Shinnecock: 1.61 KM
Moriches: 1.49 KM
Jamaica Bay: 2.24 KM
Napeague Harbor: 1.98 KM
Cold Spring Pond: 0.52 KM

**I think I need to measure these for real somehow to determine which bay is the most productive per unit area**
https://jamesepaterson.github.io/jamespatersonblog/03_trackingworkshop_homeranges
we could do this by calculating minimum convex polygons but we'd have to fix lyndie's data for Cold Spring pond first. 
We should do this in a different R script.


```{r, echo=FALSE, warning=FALSE}
library("tidyr")
library("ggplot2")
library("plyr")
library("purrr")
library("dplyr")
```

**My Data**
```{r}
#keeping everything in this folder
setwd("/Users//tdolan/Documents//R-Github//WFFieldSurveyPaper")
somedata3<-read.csv("somedata3_Mar-4-2020.csv", na.strings="", header=TRUE)
#somedata4 <-dplyr::select(somedata3,-rcpT,-std_cpue,-cpue)
```

##**Calculate CDFS for available vs. occupied habitat**##  
Separately for each bay, but with data grouped across years.   

Split data by bays : **Change this chunk each time** other chunks remain the same. 
```{r, include=TRUE, echo=TRUE}
SomeData <-somedata3 %>% dplyr::select(-minl, -maxl, -sdl, -distswept, -Tow, -Towindex) %>% mutate(Pres =ifelse(cpT > 0,1,0))%>%
  unite(BayYear,Bay,Year, remove=FALSE)%>% base::split(.$Bay)
Bay <-SomeData$`Shinnecock` # Just change out the bay you are looking at. 

total.area <- 1.61*1000 #for Shinnecock
       #   <- 1.49*1000 #for Moriches
       #   <- 2.24*1000 #for Jamaica
       #   <- 1.98*1000 #for Napeague
       #   <- 0.52*1000 #for Cold Spring Pond
      #    <- 0.37*1000 #for Mattituck
```


**Total Productivity by bay calculation**
```{r}
all.area <-(1.61*1000) + (1.49*1000) + (2.24*1000) + (1.98*1000) + (0.52*1000) +(0.37*1000)

SomeData2 <-somedata3 %>% dplyr::select(-minl, -maxl, -sdl, -distswept, -Tow, -Towindex) %>% mutate(Pres =ifelse(cpT > 0,1,0))%>%
  unite(BayYear,Bay,Year, remove=FALSE)

#Skyler's way function:
split.bay <- SomeData2 %>% base::split(.$Bay) 
skyprod <-function(df, areA) {
dat.eq1 <-ddply(df, ~Year, summarize, nh=n_distinct(X)) %>% mutate(Prop=(areA*1000)/nh) 
df <-left_join(df, dat.eq1) %>%  mutate(Prod=Prop*cpT)
df.prod <-ddply(df, ~Year, summarize, sumProd=sum(Prod))
print(c(df.prod$sumProd,mean(df.prod$sumProd),sd(df.prod$sumProd)))}

a <-skyprod(split.bay$Shinnecock,1.61)
a <- as.data.frame(cbind(c(2010,2011,2016,2017,"mean","sd"),a)); names(a) <-c("year","Shinnecock")
a <-mutate(a,year=as.factor(year))
b <-skyprod(split.bay$Jamaica,2.24)
b <- as.data.frame(cbind(c(2010,2011,2016,"mean","sd"),b)); names(b) <-c("year","Jamaica") 
b <-mutate(b,year=as.factor(year)) %>% full_join(a, by="year")
c <-skyprod(split.bay$Moriches,1.49)
c <- as.data.frame(cbind(c(2010,2011,2016,"mean","sd"),c)); names(c) <-c("year","Moriches")
c <-mutate(c,year=as.factor(year)) %>% full_join(b, by="year")
d <-skyprod(split.bay$Napeague,1.98)
d <- as.data.frame(cbind(c(2010,2016,"mean","sd"),d)); names(d) <-c("year","Napeague")
d<-mutate(d,year=as.factor(year))%>% full_join(c, by="year")
e <-skyprod(split.bay$`Cold Spring Pond`,0.52)
e <- as.data.frame(cbind(c(2010,"mean","sd"),e)); names(e) <-c("year","Cold Spring Pond") 
e <-mutate(e,year=as.factor(year))%>% full_join(d, by="year")

#peak, week before peak, and week after peak
# ratio of the peak to the whole season. or just the peak and the sum overall. 
#for bays with two peaks do the bigger peak. 

MTtows <-read.csv("mt YOY length and weight.csv",header=TRUE)
MTtows <-mutate(MTtows, len = as.numeric(Length..mm.), Tow=as.factor(Tow), Date=as.Date(Date)) %>%mutate(pres = ifelse(is.na(len),0,1))
MTcpt <-ddply(MTtows, Date~Tow, summarize, cpT=sum(pres)) %>% separate(Date, c("Year","m","d"),sep="-", remove=FALSE) %>% dplyr::rename(X=Tow)

f <-skyprod(MTcpt,0.37)
f <- as.data.frame(cbind(c(2015, 2016,"mean","sd"),f)); names(f) <-c("year","Mattituck")
f <-mutate(f,year=as.factor(year))%>% full_join(e, by="year")

x <-c("2010","2011","2015","2016","2017","mean","sd")
f.season<- f %>% slice(match(x,year))


gatherseason <-f.season%>%
  pivot_longer(c(Mattituck,`Cold Spring Pond`,Napeague,Moriches,Jamaica,Shinnecock),names_to = "Bay",values_to = "value") %>%na.omit() %>%
 unite(BayYear, Bay, year, sep=" ", remove=FALSE)%>%mutate(value=as.numeric(as.character(value)))

gatherseason.nosd <-filter(gatherseason, year !="sd")


drabcolors <-c("#f6eff7","#d0d1e6","#a6bddb", "#67a9cf", "#1c9099", "#016450")

gatherseason.nosd %>%
  filter(year %in% c(2010,2011,2015,2016,2017))%>%
  ggplot(aes(x=BayYear,y=value, fill=Bay)) +
  geom_bar(stat="identity", position="dodge")+ ylim(c(0,35000))+

  #geom_errorbar(aes(ymin=`95% LCI`, ymax=`95% UCI`),
   #               width=.2,position=position_dodge(.9), colour="lightgrey")+
  scale_fill_manual(values=drabcolors)+
  #facet_wrap(~year)+
  xlab("")+ylab("density")+
  theme(axis.text.x = element_text(angle = 90),panel.background = element_rect(fill = "white", colour = "white"))
#ggsave("bayprod_season.png", path="/Users/tdolan/documents/WF SK PROJ/Survey data/Field Survey Paper/final figures")
#dev.off()

```

Repeat the above analysis but for the days before and after the peak. 
```{r}
eday <- function(df){
  edays <-c()
for (i in 2:length(df$Date)){
  edays[i] <-df$Date[i]-df$Date[1]}
edays[1] <-0
df <-cbind(df,edays)
}
prepeak <-somedata3%>% dplyr::select(-minl, -maxl, -sdl, -distswept, -Tow, -Towindex) %>% mutate(Date=as.Date(Date))%>%
  unite(BayYear,Bay,Year, remove=FALSE)%>% arrange(Date)%>% base::split(.$BayYear) %>% map(eday)  #very important to arrange by date first. 

findpeak <-ddply(somedata3, Bay~Year~Date, summarize, new.cpue=sum(cpT)/sum(area))

#what about instead of edays we just literally use the date would that work? 

#subset the dataset to before the peak by manually looking at what eday corresponds to the maximum cpue, the day before and after. 
prepeak_CSP10 <-filter(prepeak$`Cold Spring Pond_2010`, edays %in% c(0,7)) 
prepeak_J10 <-filter(prepeak$`Jamaica_2010`, edays %in% c(0,17))
prepeak_J11 <-filter(prepeak$`Jamaica_2011`, edays %in% c(0,28,42))
prepeak_J16 <-filter(prepeak$`Jamaica_2016`, edays %in% c(0,7))
prepeak_M10 <-filter(prepeak$`Moriches_2010`, edays %in% c(8,24,44))
prepeak_M11 <-filter(prepeak$`Moriches_2011`, edays %in% c(23,35,49))  
prepeak_M16 <-filter(prepeak$`Moriches_2016`, edays %in% c(23,30,37)) 
prepeak_N10 <-filter(prepeak$`Napeague_2010`, edays %in% c(0,21))
prepeak_N16 <-filter(prepeak$`Napeague_2016`, edays %in% c(21, 27, 35))
prepeak_Sh10 <-filter(prepeak$`Shinnecock_2010`, edays %in% c(9,27, 43)) #First peak
prepeak_Sh11 <-filter(prepeak$`Shinnecock_2011`, edays %in% c(0,25)) #First peak, second peak is at edays=79
prepeak_Sh16 <-filter(prepeak$`Shinnecock_2016`, edays %in% c(23, 30, 37)) #First peak, second peak, which is slightly larger, is at edays=56
prepeak_Sh17 <-filter(prepeak$`Shinnecock_2017`, edays %in% c(12, 20, 26)) #first peak, second peak, which is smaller, is at edays=47
prepeak_MT15 <-filter(MTcpt, Year=="2015") %>% eday() %>% filter(edays  %in% c(0, 13, 27)) %>% mutate(Year=as.integer(Year), X=as.integer(X), Bay="Mattituck")
prepeak_MT16 <<-filter(MTcpt, Year=="2016") %>% eday() %>% filter(edays  %in% c(11, 28, 39)) %>% mutate(Year=as.integer(Year),X=as.integer(X),Bay="Mattituck")
prepeak <-bind_rows(prepeak_CSP10,prepeak_J10,prepeak_J11,prepeak_J16,prepeak_M10,prepeak_M11,prepeak_M16,prepeak_N10,prepeak_N16,prepeak_Sh10,prepeak_Sh11,prepeak_Sh16,prepeak_Sh17, prepeak_MT15, prepeak_MT16) 

#use Skyler's way function:
split.bay <- prepeak %>% base::split(.$Bay) 

a <-skyprod(split.bay$Shinnecock,1.61)
a <- as.data.frame(cbind(c(2010,2011,2016,2017,"mean","sd"),a)); names(a) <-c("year","Shinnecock")
a <-mutate(a,year=as.factor(year))
b <-skyprod(split.bay$Jamaica,2.24)
b <- as.data.frame(cbind(c(2010,2011,2016,"mean","sd"),b)); names(b) <-c("year","Jamaica") 
b <-mutate(b,year=as.factor(year)) %>% full_join(a, by="year")
c <-skyprod(split.bay$Moriches,1.49)
c <- as.data.frame(cbind(c(2010,2011,2016,"mean","sd"),c)); names(c) <-c("year","Moriches")
c <-mutate(c,year=as.factor(year)) %>% full_join(b, by="year")
d <-skyprod(split.bay$Napeague,1.98)
d <- as.data.frame(cbind(c(2010,2016,"mean","sd"),d)); names(d) <-c("year","Napeague")
d<-mutate(d,year=as.factor(year))%>% full_join(c, by="year")
e <-skyprod(split.bay$`Cold Spring Pond`,0.52)
e <- as.data.frame(cbind(c(2010,"mean","sd"),e)); names(e) <-c("year","Cold Spring Pond") 
e <-mutate(e,year=as.factor(year))%>% full_join(d, by="year")
f <-skyprod(MTcpt,0.37)
f <- as.data.frame(cbind(c(2015, 2016,"mean","sd"),f)); names(f) <-c("year","Mattituck")
f <-mutate(f,year=as.factor(year))%>% full_join(e, by="year")

x <-c("2010","2011","2015","2016","2017","mean","sd")
f.prepeak<- f %>% slice(match(x,year))

gatherpp <-f.prepeak%>%
  pivot_longer(c(Mattituck,`Cold Spring Pond`,Napeague,Moriches,Jamaica,Shinnecock),names_to = "Bay",values_to = "value") %>%na.omit() %>%
 unite(BayYear, Bay, year, sep=" ", remove=FALSE)%>%mutate(value=as.numeric(as.character(value)))

gatherpp.nosd <-filter(gatherpp, year !="sd")


drabcolors <-c("#f6eff7","#d0d1e6","#a6bddb", "#67a9cf", "#1c9099", "#016450")

gatherpp.nosd %>%
  filter(year %in% c(2010,2011,2015,2016,2017))%>%
  ggplot(aes(x=BayYear,y=value, fill=Bay)) +
  geom_bar(stat="identity", position="dodge")+ #ylim(c(0,35000))+

  #geom_errorbar(aes(ymin=`95% LCI`, ymax=`95% UCI`),
   #               width=.2,position=position_dodge(.9), colour="lightgrey")+
  scale_fill_manual(values=drabcolors)+
  #facet_wrap(~year)+
  xlab("")+ylab("density")+
  theme(axis.text.x = element_text(angle = 90),panel.background = element_rect(fill = "white", colour = "white"))
#ggsave("bayprod_prepeak.png", path="/Users/tdolan/documents/WF SK PROJ/Survey data/Field Survey Paper/final figures")
#dev.off()


```



